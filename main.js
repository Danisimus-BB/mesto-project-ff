(()=>{"use strict";const e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-24",headers:{authorization:"15184d6e-c892-47df-b333-ddc708502e5f","Content-Type":"application/json"}},t=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),r=e=>fetch(e,{headers:{authorization:"15184d6e-c892-47df-b333-ddc708502e5f"}});function o(r,o){return fetch(r,{method:o,headers:e.headers}).then((e=>t(e)))}const n=document.querySelector("#card-template").content;function a(e,t,r,o,a){const u=n.querySelector(".places__item").cloneNode(!0),c=u.querySelector(".card__image"),s=u.querySelector(".card__title"),p=u.querySelector(".card__delete-button"),i=u.querySelector(".card__like-button"),l=u.querySelector(".card__like-counter");return c.src=o.link,c.alt=o.name,s.textContent=o.name,l.textContent=String(o.likes.length),a===o.owner._id?p.addEventListener("click",(()=>{e(u,o)})):u.removeChild(p),i.addEventListener("click",(()=>{t(i,l,o,a)})),c.addEventListener("click",(()=>{r(s,c)})),u}function u(r,o){var n;(n=`${e.baseUrl}/cards/${o._id}`,fetch(n,{method:"DELETE",headers:e.headers}).then((e=>t(e)))).then((e=>(r.remove(),e))).catch((e=>{console.log(e)}))}async function c(t,n,a,u){const c=await r(`${e.baseUrl}/cards`),s=await c.json();(()=>{for(let e of Object.values(s))if(e._id===a._id)return e})().likes.some((e=>e._id===u))?o(`${e.baseUrl}/cards/likes/${a._id}`,"DELETE").then((e=>{t.classList.remove("card__like-button_is-active"),n.textContent=e.likes.length})).catch((e=>{console.log(e)})):o(`${e.baseUrl}/cards/likes/${a._id}`,"PUT").then((e=>{t.classList.add("card__like-button_is-active"),n.textContent=e.likes.length})).catch((e=>{console.log(e)}))}function s(e){const t=document.querySelector(".popup_is-opened");"Escape"===e.key&&i(t)}function p(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",s)}function i(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",s)}const l=(e,t,r,o)=>{const n=e.querySelector(`.${t.id}-error`);t.classList.remove(r),n.classList.remove(o),n.textContent=""},d=e=>{((e,t,r,o,n)=>{const a=document.querySelector(e),u=Array.from(a.querySelectorAll(t)),c=a.querySelector(r);u.forEach((e=>{e.addEventListener("input",(function(){"link"!==e.name&&function(e){/^[a-zA-Zа-яА-Я- ]*$/.test(e.value)?(e.setCustomValidity(""),e.setAttribute("validity","valid")):(e.setCustomValidity(e.dataset.error),e.setAttribute("validity","invalid"))}(e),((e,t,r,o)=>{t.validity.valid?l(e,t,r,o):((e,t,r,o,n)=>{const a=e.querySelector(`.${t.id}-error`);t.classList.add(o),a.textContent=r,a.classList.add(n)})(e,t,t.validationMessage,r,o)})(a,e,o,n),((e,t)=>{(e=>e.some((e=>!e.validity.valid)))(e)?t.setAttribute("disabled",""):t.removeAttribute("disabled","")})(u,c)}))}))})(e.formSelector,e.inputSelector,e.submitButtonSelector,e.inputErrorClass,e.errorClass),document.querySelector(e.formSelector).addEventListener("submit",(function(e){e.preventDefault()}))},_=(e,t)=>{const r=Array.from(e.querySelectorAll(t.inputSelector));e.querySelector(t.submitButtonSelector).setAttribute("disabled",""),r.forEach((r=>{r.setCustomValidity(""),l(e,r,t.inputErrorClass,t.errorClass)}))},m=document.querySelector(".places__list"),y=document.querySelectorAll(".popup"),v=document.querySelector(".profile__edit-button"),S=document.querySelector(".popup_type_edit"),f=document.querySelector(".popup_type_avatar"),b=document.querySelector(".popup_type_new-card"),h=document.querySelectorAll(".popup__close"),C=S.querySelector(".popup__form"),q=b.querySelector(".popup__form"),E=f.querySelector(".popup__form"),g=C.querySelector(".popup__button"),k=C.querySelector('input[name="name"]'),L=C.querySelector('input[name="description"]'),x=E.querySelector(".popup__input"),w=f.querySelector(".popup__button"),$=document.querySelector(".profile__title"),A=document.querySelector(".profile__image"),U=document.querySelector(".profile__description"),j=b.querySelector(".popup__input_type_card-name"),B=b.querySelector(".popup__input_type_url"),D=document.querySelector(".profile__add-button"),T=document.querySelector(".popup_type_new-card"),O=b.querySelector(".popup__button"),P=document.querySelector(".popup_type_image"),I=P.querySelector(".popup__image"),N=P.querySelector(".popup__caption");function z(e,t){p(P),I.src=t.src,I.alt=t.alt,N.textContent=e.textContent}!async function(){const t=await r(`${e.baseUrl}/users/me`),o=await r(`${e.baseUrl}/cards`),n=await t.json(),s=await o.json(),p=n._id;try{$.textContent=n.name,U.textContent=n.about,A.style.backgroundImage=`url('${n.avatar}')`,s.forEach((e=>{const t=a(u,c,z,e,p);m.append(t)}))}catch(e){console.log(e)}}(),d({formSelector:".popup_type_edit",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),d({formSelector:".popup_type_avatar",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),d({formSelector:".popup_type_new-card",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),v.addEventListener("click",(()=>{C.reset(),k.value=$.textContent,L.value=U.textContent,_(C,{inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),p(S)})),A.addEventListener("click",(()=>{E.reset(),_(f,{inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),p(f)})),D.addEventListener("click",(()=>{q.reset(),_(q,{inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),p(T)}));for(let e of h)e.addEventListener("click",(()=>{i(e.closest(".popup"))}));for(let e of y)e.classList.add("popup_is-animated"),e.addEventListener("click",(t=>{t.target.classList.contains("popup")&&i(e)}));C.addEventListener("submit",(r=>{r.preventDefault(),async function(){g.textContent="Сохранение...";try{await(r=k.value,o=L.value,fetch(`${e.baseUrl}/users/me`,{method:"PATCH",headers:e.headers,body:JSON.stringify({name:r,about:o})}).then((e=>t(e))))}catch(e){console.error("Ошибка:",e)}finally{g.textContent="Сохранить"}var r,o}().then((()=>{$.textContent=k.value,U.textContent=L.value,i(S)})).catch((e=>{console.log(e)}))})),E.addEventListener("submit",(r=>{r.preventDefault(),async function(){w.textContent="Сохранение...";try{await(r=x.value,fetch(`${e.baseUrl}/users/me/avatar`,{method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:r})}).then((e=>t(e))))}catch(e){console.error("Ошибка:",e)}finally{w.textContent="Создать"}var r}().then((()=>{A.style.backgroundImage=`url('${x.value}')`,i(f)})).catch((e=>{console.log(e)}))})),q.addEventListener("submit",(o=>{o.preventDefault();const n={name:j.value,link:B.value};(async function(){O.textContent="Сохранение...";try{const o=await r(`${e.baseUrl}/users/me`),a=(await o.json())._id;await function(r,o){return fetch(`${e.baseUrl}/cards`,{method:"POST",headers:e.headers,body:JSON.stringify({name:r,link:o})}).then((e=>t(e)))}(...Object.values(n));const u=await r(`${e.baseUrl}/cards`);return{cardsData:await u.json(),myId:a}}catch(e){console.error("Ошибка:",e),O.textContent="Сохранить"}finally{O.textContent="Сохранить"}})().then((({cardsData:e,myId:t})=>{const r=a(u,c,z,e[0],t);m.prepend(r),i(T),j.value="",B.value=""})).catch((e=>{console.log(e)}))}))})();