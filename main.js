(()=>{"use strict";const e={baseUrl:"https://nomoreparties.co/v1/wff-cohort-24",headers:{authorization:"15184d6e-c892-47df-b333-ddc708502e5f","Content-Type":"application/json"}},t=e=>e.ok?e.json():Promise.reject(`Ошибка: ${e.status}`),o=e=>fetch(e,{headers:{authorization:"15184d6e-c892-47df-b333-ddc708502e5f"}});function r(o,r,n){return fetch(o,{method:r,headers:e.headers}).then((e=>t(e))).then((e=>{n.textContent=e.likes.length})).catch((e=>{console.log(e)}))}const n=document.querySelector("#card-template").content;function c(e,t,o,r,c){const a=n.querySelector(".places__item").cloneNode(!0),u=a.querySelector(".card__image"),s=a.querySelector(".card__title"),p=a.querySelector(".card__delete-button"),i=a.querySelector(".card__like-button"),l=a.querySelector(".card__like-counter");return u.src=r.link,u.alt=r.name,s.textContent=r.name,l.textContent=String(r.likes.length),c===r.owner._id?p.addEventListener("click",(()=>{e(a,r)})):a.removeChild(p),i.addEventListener("click",(()=>{t(i,l,r,c)})),u.addEventListener("click",(()=>{o(s,u)})),a}function a(o,r){var n;o.remove(),n=`${e.baseUrl}/cards/${r._id}`,fetch(n,{method:"DELETE",headers:e.headers}).then((e=>t(e))).catch((e=>{console.log(e)}))}async function u(t,n,c,a){const u=await o(`${e.baseUrl}/cards`),s=await u.json();(()=>{for(let e of Object.values(s))if(e._id===c._id)return e})().likes.some((e=>e._id===a))?r(`https://nomoreparties.co/v1/wff-cohort-24/cards/likes/${c._id}`,"DELETE",n).then((()=>{t.classList.remove("card__like-button_is-active")})).catch((e=>{console.log(e)})):r(`https://nomoreparties.co/v1/wff-cohort-24/cards/likes/${c._id}`,"PUT",n).then((()=>{t.classList.add("card__like-button_is-active")})).catch((e=>{console.log(e)}))}const s=document.querySelector(".popup_is-opened");function p(e){"Escape"===e.key&&l(s)}function i(e){e.classList.add("popup_is-opened"),document.addEventListener("keydown",p)}function l(e){e.classList.remove("popup_is-opened"),document.removeEventListener("keydown",p);const t=e.querySelectorAll("input");for(let e of t)e.value=""}const d=(e,t,o,r)=>{const n=e.querySelector(`.${t.id}-error`);t.classList.remove(o),n.classList.remove(r),n.textContent=""},_=e=>{((e,t,o,r,n)=>{const c=document.querySelector(e),a=Array.from(c.querySelectorAll(t)),u=c.querySelector(o);a.forEach((e=>{e.addEventListener("input",(function(){"link"!==e.name&&function(e){/^[a-zA-Zа-яА-Я- ]*$/.test(e.value)?(e.setCustomValidity(""),e.setAttribute("validity","valid")):(e.setCustomValidity(e.dataset.error),e.setAttribute("validity","invalid"))}(e),((e,t,o,r)=>{t.validity.valid?d(e,t,o,r):((e,t,o,r,n)=>{const c=e.querySelector(`.${t.id}-error`);t.classList.add(r),c.textContent=o,c.classList.add(n)})(e,t,t.validationMessage,o,r)})(c,e,r,n),((e,t)=>{(e=>e.some((e=>!e.validity.valid)))(e)?t.setAttribute("disabled",""):t.removeAttribute("disabled","")})(a,u)}))}))})(e.formSelector,e.inputSelector,e.submitButtonSelector,e.inputErrorClass,e.errorClass),document.querySelector(e.formSelector).addEventListener("submit",(function(e){e.preventDefault()}))},m=(e,t)=>{const o=Array.from(e.querySelectorAll(t.inputSelector));e.querySelector(t.submitButtonSelector).setAttribute("disabled",""),o.forEach((o=>{o.setCustomValidity(""),d(e,o,t.inputErrorClass,t.errorClass)}))},y=document.querySelector(".places__list"),f=document.querySelectorAll(".popup"),v=document.querySelector(".profile__edit-button"),S=document.querySelector(".popup_type_edit"),h=document.querySelector(".popup_type_avatar"),b=document.querySelector(".popup_type_new-card"),q=document.querySelectorAll(".popup__close"),C=S.querySelector(".popup__form"),g=b.querySelector(".popup__form"),E=h.querySelector(".popup__form"),k=C.querySelector('input[name="name"]'),L=C.querySelector('input[name="description"]'),w=E.querySelector(".popup__input"),x=document.querySelector(".profile__title"),A=document.querySelector(".profile__image"),$=document.querySelector(".profile__description"),j=b.querySelector(".popup__input_type_card-name"),B=b.querySelector(".popup__input_type_url"),T=document.querySelector(".profile__add-button"),U=document.querySelector(".popup_type_new-card"),D=document.querySelector(".popup_type_image"),O="https://nomoreparties.co/v1/wff-cohort-24/cards",P="https://nomoreparties.co/v1/wff-cohort-24/users/me";function N(e,t){i(D);const o=D.querySelector(".popup__image"),r=D.querySelector(".popup__caption");o.src=t.src,o.alt=t.alt,r.textContent=e.textContent}!async function(){const e=await o(P),t=await o(O),r=await e.json(),n=await t.json(),s=r._id;try{x.textContent=r.name,$.textContent=r.about,A.style.backgroundImage=`url('${r.avatar}')`,n.forEach((e=>{const t=c(a,u,N,e,s);y.append(t)}))}catch(e){console.log(e)}}(),_({formSelector:".popup_type_edit",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),_({formSelector:".popup_type_avatar",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),_({formSelector:".popup_type_new-card",inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),v.addEventListener("click",(()=>{k.value=x.textContent,L.value=$.textContent,m(C,{inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),i(S)})),A.addEventListener("click",(()=>{m(h,{inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),i(h)})),T.addEventListener("click",(()=>{m(g,{inputSelector:".popup__input",submitButtonSelector:".popup__button",inputErrorClass:"popup__input_type_error",errorClass:"popup__error-message_active"}),i(U)}));for(let e of q)e.addEventListener("click",(()=>{l(e.closest(".popup"))}));for(let e of f)e.classList.add("popup_is-animated"),e.addEventListener("click",(t=>{t.target.classList.contains("popup")&&l(e)}));C.addEventListener("submit",(o=>{o.preventDefault(),async function(){const o=C.querySelector(".popup__button");o.textContent="Сохранение...";try{await(r=k.value,n=L.value,fetch(`${e.baseUrl}/users/me`,{method:"PATCH",headers:e.headers,body:JSON.stringify({name:r,about:n})}).then((e=>t(e))).catch((e=>{console.log(e)})))}catch(e){console.error("Ошибка:",e)}finally{o.textContent="Сохранить"}var r,n}().then((()=>{x.textContent=k.value,$.textContent=L.value,l(S)})).catch((e=>{console.log(e)}))})),E.addEventListener("submit",(o=>{o.preventDefault(),async function(){const o=h.querySelector(".popup__button");o.textContent="Сохранение...";try{await(r=w.value,fetch(`${e.baseUrl}/users/me/avatar`,{method:"PATCH",headers:e.headers,body:JSON.stringify({avatar:r})}).then((e=>t(e))).catch((e=>{console.log(e)})))}catch(e){console.error("Ошибка:",e)}finally{o.textContent="Создать"}var r}().then((()=>{A.style.backgroundImage=`url('${w.value}')`,l(h)})).catch((e=>{console.log(e)}))})),g.addEventListener("submit",(r=>{r.preventDefault();const n={name:j.value,link:B.value};(async function(){const r=await o(P),s=(await r.json())._id,p=b.querySelector(".popup__button");p.textContent="Сохранение...";try{await function(o,r){return fetch(`${e.baseUrl}/cards`,{method:"POST",headers:e.headers,body:JSON.stringify({name:o,link:r})}).then((e=>t(e))).catch((e=>{console.log(e)}))}(...Object.values(n))}catch(e){console.error("Ошибка:",e),p.textContent="Сохранить"}finally{const e=await o(O),t=c(a,u,N,(await e.json())[0],s);y.prepend(t),p.textContent="Сохранить"}})().then((()=>{l(U),j.value="",B.value=""})).catch((e=>{console.log(e)}))}))})();